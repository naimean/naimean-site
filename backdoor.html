<script>
// ------------------------------
// Load messages from localStorage
// ------------------------------
function loadMessages() {
    const saved = localStorage.getItem("shoutboxMessages");
    return saved ? JSON.parse(saved) : [];
}

// ------------------------------
// Save messages
// ------------------------------
function saveMessages(messages) {
    localStorage.setItem("shoutboxMessages", JSON.stringify(messages));
}

// ------------------------------
// Detect image URLs and convert to <img>
// ------------------------------
function convertImageURLs(text) {
    const imageExtensions = ['.gif', '.png', '.jpg', '.jpeg', '.webp'];

    const trimmed = text.trim();

    // Try to treat the text as a URL
    try {
        const url = new URL(trimmed);
        const lower = url.pathname.toLowerCase();

        // If URL ends with an image extension → embed it
        if (imageExtensions.some(ext => lower.endsWith(ext))) {
            return `<img src="${url.href}" class="shout-image" style="max-width:100%; border:1px solid #39ff14;">`;
        }
    } catch (e) {
        // Not a URL — ignore
    }

    return text; // Return original text if not an image URL
}

// ------------------------------
// Render messages
// ------------------------------
function renderMessages() {
    const container = document.getElementById("shoutbox-messages");
    container.innerHTML = "";

    const messages = loadMessages();

    messages.forEach((msg, index) => {
        const div = document.createElement("div");
        div.className = "shout";

        div.innerHTML = `
            <div class="shout-content" style="color:#39ff14;">
                ${convertImageURLs(msg.text)}
            </div>
            <button class="delete-btn" onclick="deleteMessage(${index})"
                style="background:none; border:none; color:#39ff14; float:right; cursor:pointer;">
                ✖
            </button>
        `;

        container.appendChild(div);
    });
}

// ------------------------------
// Add a new message
// ------------------------------
function addMessage() {
    const input = document.getElementById("shoutbox-input");
    let text = input.value.trim();

    if (text === "") return;

    const messages = loadMessages();
    messages.push({ text });
    saveMessages(messages);

    input.value = "";
    renderMessages();
}

// ------------------------------
// Delete a message
// ------------------------------
function deleteMessage(index) {
    const messages = loadMessages();
    messages.splice(index, 1);
    saveMessages(messages);
    renderMessages();
}

// ------------------------------
// Handle paste (auto‑detect image files)
// ------------------------------
document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("shoutbox-input");

    input.addEventListener("paste", async (event) => {
        const clipboard = event.clipboardData;

        // If user pastes an actual image file
        for (const item of clipboard.items) {
            if (item.type.startsWith("image/")) {
                event.preventDefault();

                const file = item.getAsFile();
                const url = URL.createObjectURL(file);

                input.value = url;
                return;
            }
        }

        // Otherwise normal paste
    });

    renderMessages();
});
</script>
